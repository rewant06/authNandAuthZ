generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  MANAGE // ALL
}

// (Action)
enum ActivityLogActionType {
  CREATE
  UPDATE
  DELETE
  EXECUTE // For custom actions like "USER_LOGIN
}

//  (The outcome)
enum ActivityLogStatus {
  SUCCESS
  FAILED
}


model User {
  id             String         @id @default(cuid())
  email          String         @unique
  name           String?
  roles           Role[]
  activityLogs    ActivityLog[]
  hashedPassword String?
  refreshTokens  RefreshToken[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique // e.g., "ADMIN", "USER", "MODERATOR"
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // A role can be assigned to many users
  users       User[]
  // A role has many permissions
  permissions Permission[]
}

model Permission {
  id        String   @id @default(cuid())
  action    PermissionAction
  // The subject: e.g., "User", "AuditLog", "Comment"
  // We use "all" to represent "any subject" (e.g., for a super-admin)
  subject   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // A permission can be granted to many roles
  roles     Role[]

  @@unique([action, subject]) // Ensure "READ:User" can only exist once
}

model RefreshToken {
  id         String      @id @default(cuid())
  tokenHash  String
  userId     String
  user       User      @relation(fields: [userId], references: [id])
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  revoked    Boolean   @default(false)
  device     String?
  replacedBy String? // to store id of replacing token
  lastUsedAt DateTime?
}

model ActivityLog {
  id              String                @id @default(cuid())
  actorId         String?
  actor           User?                 @relation(fields: [actorId], references: [id], onDelete: SetNull)
  actorSnapshot   Json?
  // (WHAT)
  actionType      ActivityLogActionType
  status          ActivityLogStatus
  failureReason   String?               @db.Text
  // (AFFECTED)
  entityType      String
  entityId        String?

  changes         Json?
  context         Json?
  createdAt       DateTime              @default(now())

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([actionType])
}
